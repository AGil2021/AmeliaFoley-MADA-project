---
title: "analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#load packages and data
```{r}
library(ggplot2) #for plotting
library(broom) #for cleaning up output from lm()
library(here) #for data loading/saving
library(tidymodels) #for modeling

data <- readRDS(here("data", "processed_data", "athensland.rds"))
```

# fit linear model to continuous outcome (particles_l)
```{r}
#attempt to visualize data
#look at particles per L vs population
ggplot(data, aes(x = population, y = particles_l)) + geom_point() + geom_smooth(method = lm)
```
# linear regression
```{r}
#linear regression model specification set up
lm_mod <- linear_reg() %>% set_engine("lm")
#estimating/training linear model
lm_fit1 <- lm_mod %>% fit(particles_l ~ ., data = data)
#view summary of fit
tidy(lm_fit1)
```
# model evaluation
```{r}
#split into test and train
#set seed for reproducible analysis
set.seed(222)
#subset 3/4 of data as training set
data_split <- initial_split(data, prop = 3/4)

#save sets as data frames
train_data <- training(data_split)
test_data <- testing(data_split)
```

# recipe to fit continuous outcome to all predictors
```{r}
#recipe for particles per liter, all predictors
mp_rec <- 
  recipe(particles_l ~ ., data = train_data)

#linear regression model workflow set up
mp_wflow <- 
  workflow() %>% add_model(lm_mod) %>% add_recipe(mp_rec)

#use workflow to prepare recipe and train model with predictors
mp_fit <- 
  mp_wflow %>% fit(data = train_data)

#extract model coefficient
mp_fit %>% extract_fit_parsnip() %>% tidy()
```

Here, where model coefficient are extracted, the terms are individual sites rather than the different variable predictors we want to look like, unlike in last weeks exercise. Maybe I need to go back and remove the variables that aren't going to be helpful predictors (ex: site name) 

# evaluate model with ROC and ROC-AUC
```{r}
#use trained workflow to predict with test data
test_data <- test_data[-c(20:28),]
predict(mp_fit, test_data)

#include probabilities
mp_aug <- augment(mp_fit, test_data)

#get RMSE for test data
mp_aug %>% rmse(truth = particles_l, .pred)

```

Why are there so many rows resulting? When we did the analysis last week, only one row was the result, and it was just rmse and provided a value around 1. 

Here, I am running into an issue since july_21 data is still missing. Hopefully we'll get that from Megan soon. For now, let's try filtering it out. 

The error message about levels is indicating that these results appear in the test data but not the train data. However, this values should be continuous and not categorical. let's check on the class of the variable to see what's going on. 

```{r}
class(test_data$e.coli.cfu)
```

Okay, e.coli.cfu has been saved as a character rather than numeric/double. I encountered this issue earlier in exploration but it looks like I neglected to save an updated version of the dataset. Let's go back to the processing code and adjust this. 
